<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
 
 <mapper namespace="com.lec.tx.mapper.UsersMapper">
 
	<select id="usersList" resultMap="userMap">
		select u.user_seq, u.user_name, u.user_id, u.user_pw, u.regdate,
	    r.role_seq, r.role_name
	    from users u, roles r
	    where u.user_seq = r.user_seq
	    order by u.user_seq asc, r.role_seq asc
	</select>
 	
 	<resultMap id="userMap" type="com.lec.users.UsersJoinRolesVO">
 		<id property="usersSeq" column="user_seq"/>
 		<result property="usersName" column="user_name"/>
 		<result property="usersId" column="user_id"/>
 		<result property="usersPw" column="user_pw"/>
 		<result property="regdate" column="regdate"/>
 		<result property="roleSeq" column="role_seq"/>
 		<result property="roleName" column="role_name"/>
 	
 	</resultMap>
 	
 	
 	<select id="usersOne" parameterType="int" resultMap="userMap">
 		select u.user_seq, u.user_name, u.user_id, u.user_pw, u.regdate
		    , r.role_seq , r.role_name
		from users u, roles r
		where u.user_seq=#{usersSeq} and u.user_seq = r.user_seq and r.role_name = 'ROLE_USER'
 	</select>
 	
 	<select id="usersLogin" resultMap="userMap">
		select u.user_seq, u.user_name, u.user_id, u.user_pw, u.regdate
			    , r.role_seq , r.role_name
		from users u, roles r
		where u.user_id=#{usersId} and u.user_pw=#{usersPw}
		      and u.user_seq = r.user_seq
	</select>
 	
 	
 	<insert id="usersInsert" parameterType="com.lec.users.UsersVO">
 		insert into users(users_seq, user_name, user_id, user_pw, regdate) 
 		values(users_seq.nextval, #{usersVO.usersName}, #{usersVO.usersId},#{usersVO.usersPw}, sysdate)
 		
 		insert into roles(role_seq, role_name, user_seq, regdate)
 		values (roles_seq.nextval, #{rolesVO.roleName}, #{usersVO.userSeq}, sysdate};
 	</insert>
 	
 	<update id="usersUpdate" parameterType="com.lec.users.UsersVO">
 		update users set user_name=#{usersName} where user_seq=#{usersSeq}
 		<!-- insert 넣기 -->
 	</update>
 	
 	<delete id="usersDelete" parameterType="int">
	 	BEGIN
	 		delete from roles where user_seq=#{usersSeq}
	 		delete from users where user_seq=#{usersSeq}
	 	END;	
 	</delete>
 	
 	<!--  단일 원자성 원칙 고려할 필요 있음 ↑ 위 딜리트는 서로 일련의 과정으로 작동하기 때문에 이렇게 작성함. -->
 	
 </mapper>